use std::io::Cursor;

use base64::Engine;
use data_url::DataUrl;
use image::{DynamicImage, ImageOutputFormat};
use wasm_bindgen::prelude::wasm_bindgen;

// TODO: Instead of converting to jpeg, we should convert to webp, which is even more space efficient
// However, webp is not yet supported in wasm. See: https://github.com/jaredforth/webp/issues/20
// The webp crate is used by the image crate
#[wasm_bindgen]
pub fn data_url_to_base64_jpg(data_url: &str, quality: u8) -> String {
    let url = DataUrl::process(data_url).expect("`data_url` is not a valid data url");
    let (body, _) = url.decode_to_vec().unwrap();

    if url.mime_type().subtype == "jpeg" {
        return data_url.to_string();
    }

    let img =
        DynamicImage::ImageRgba8(image::load_from_memory(body.as_slice()).unwrap().to_rgba8());
    let mut buffer = Vec::new();
    img.write_to(
        &mut Cursor::new(&mut buffer),
        ImageOutputFormat::Jpeg(quality),
    )
    .unwrap();

    let base64 = base64::engine::general_purpose::STANDARD.encode(buffer);
    format!("data:image/jpeg;base64,{}", base64.replace("\r\n", ""))
}

#[cfg(test)]
mod tests {
    use wasm_bindgen_test::wasm_bindgen_test;

    use crate::data_url_to_base64_jpg;

    #[wasm_bindgen_test]
    fn base64_png_to_base64_jpg() {
        let base64_png = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAACGUlEQVR42u3cMU4qQQDH4f+u1vR2r/MCasMJqGg8i4ewssRjkNhjQyMnILGWY2DhPAvD46HEZJn5vmQKoyHZ2d+Oy6Db5f+uk0yTjJNcJrkIQ7ZJsk6yTDJPsvrpC02SLJJsjZMei3Iuv2Vm4qobs0NO/MhVX/1qMNoXgJPfRgSfzr4s+7fuoar3p9zIP3294XN1tDUmSdKXAO5cGM25S5KuvM9/MR9NuunLJg9tmvZlh482jbskb7Z329027sodIY3qTYEAEACtOj/2BbbbYd9CdF3n+KwACAABIAAEgAAQAAJAAAhAAAgAASAABEBrBv83gcd+Hn/s5+VWAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIgAGr/jmBtR+f5wQiAASAABAAAkAACAABIAAEgAAQAAJAAOzgOYFWAASAABAAAkAACAABIAAEgAAQAAJAAAgAASAABIAAEAACQAAIgNPlOYEnfnyeE4gAEAACQAAIAAEgAASAABAAAkAACAABsMPgnxOIFQABIAB+LYCNaWjWpk+yNg/NWvdJluahWcs+ydw8NGveJ1kleTYXzXlOsvr7LuDefDTnPknOyhevSS6SXJmXJjwmedj1jUU+toaNesdiXxkjEVR/8keHLBEzk1XdmH3398TEalDNVT/510k+5H+Lr5NMk4yTXJabRQa8vVt2d5dlj2e174ffAR5xZB8IpvtdAAAAAElFTkSuQmCC";

        let result = data_url_to_base64_jpg(base64_png, 80);

        assert_eq!(result, "data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/wAARCACAAIADAREAAhEBAxEB/9sAQwAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCko/9sAQwEHBwcKCAoTCgoTKBoWGigoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgo/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD5UoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoA/VSgAoAKACgAoA/KugAoA/VSgAoAKACgAoA/KugAoAKACgD9VKACgAoAKACgD8q6ACgD9VKACgAoAKACgD8q6ACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKAP1UoAKACgAoAKAPyroAKAP1UoAKACgAoAKAPyroAKACgAoA/VSgAoAKACgAoA/KugAoA/VSgAoAKACgAoA/KugAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgD9VKACgAoAKACgD8q6ACgD9VKACgAoAKACgD8q6ACgAoAKAP1UoAKACgAoAKAPyroAKAP1UoAKACgAoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoA//2Q==");
    }

    #[wasm_bindgen_test]
    fn base64_jpeg_is_not_modified() {
        let base64_jpeg = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/wAARCACAAIADAREAAhEBAxEB/9sAQwAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCko/9sAQwEHBwcKCAoTCgoTKBoWGigoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgo/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD5UoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoA/VSgAoAKACgAoA/KugAoA/VSgAoAKACgAoA/KugAoAKACgD9VKACgAoAKACgD8q6ACgD9VKACgAoAKACgD8q6ACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKAP1UoAKACgAoAKAPyroAKAP1UoAKACgAoAKAPyroAKACgAoA/VSgAoAKACgAoA/KugAoA/VSgAoAKACgAoA/KugAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgD9VKACgAoAKACgD8q6ACgD9VKACgAoAKACgD8q6ACgAoAKAP1UoAKACgAoAKAPyroAKAP1UoAKACgAoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoA//2Q==";

        let result = data_url_to_base64_jpg(base64_jpeg, 1);

        assert_eq!(result, "data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAAQABAAD/wAARCACAAIADAREAAhEBAxEB/9sAQwAGBAUGBQQGBgUGBwcGCAoQCgoJCQoUDg8MEBcUGBgXFBYWGh0lHxobIxwWFiAsICMmJykqKRkfLTAtKDAlKCko/9sAQwEHBwcKCAoTCgoTKBoWGigoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgo/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD5UoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoA/VSgAoAKACgAoA/KugAoA/VSgAoAKACgAoA/KugAoAKACgD9VKACgAoAKACgD8q6ACgD9VKACgAoAKACgD8q6ACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKAP1UoAKAPyroAKACgAoAKACgAoAKACgAoAKAP1UoAKACgAoAKAPyroAKAP1UoAKACgAoAKAPyroAKACgAoA/VSgAoAKACgAoA/KugAoA/VSgAoAKACgAoA/KugAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgAoAKACgD9VKACgD8q6ACgAoAKACgAoAKACgAoAKACgD9VKACgAoAKACgD8q6ACgD9VKACgAoAKACgD8q6ACgAoAKAP1UoAKACgAoAKAPyroAKAP1UoAKACgAoAKAPyroAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoAKACgAoA//2Q==");
    }
}
